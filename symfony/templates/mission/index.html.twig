{% extends 'base.html.twig' %}

{% block title %}Hello MissionController!{% endblock %}

{% block body %}

<style>
    #missionstable tbody tr {
        cursor: pointer;
    }

    #detailsMissionModal label {
        font-weight: bold;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col">
            <table
                    id="missionstable"
                    data-toolbar="#toolbar"
                    data-search="true"
                    data-show-columns="true"
                    data-show-columns-toggle-all="true"
                    data-detail-formatter="detailFormatter"
                    data-pagination="true"
                    data-id-field="id"
                    data-page-list="[10, 25, 50, 100, all]"
                    data-show-footer="false"
                    data-side-pagination="server"
                    data-url="mission/get-missions"
                    data-search-highlight="true"
                    data-response-handler="responseHandler">
            </table>
        </div>
    </div>
</div>

{% include  'mission/details.html.twig' %}

<script>
    var $table = $('#missionstable')
    var selections = []

    // To display the status badge
    const displayMissionStatus = (status) => {
        let formattedStatus = '';

        switch (status) {
            case 'inpreparation' :
                formattedStatus = '<span class="badge badge-secondary">In preparation</span>';
                break;
            case 'inprogress' :
                formattedStatus = '<span class="badge badge-warning">In progress</span>';
                break;
            case 'completed' :
                formattedStatus = '<span class="badge badge-success">Completed</span>';
                break;
            case 'failed' :
                formattedStatus = '<span class="badge badge-danger">Failed</span>';
                break;
        }

        return formattedStatus;
    }

    // To display the flag country
    const displayMissionCountry = (iso) => {
        let formattedCountry;
        formattedCountry = '<img src="images/country/'+iso.toLowerCase()+'.png" />';
        return formattedCountry;
    }

    function responseHandler(res) {
        $.each(res.rows, (i, row) => {
            row.state = $.inArray(row.id, selections) !== -1
        })
        return res
    }

    function initTable() {
        $table.bootstrapTable('destroy').bootstrapTable({
            height: 550,
            locale: 'en-US',
            columns: [
                [
                    {
                        field: 'code',
                        title: 'Code',
                        sortable: true,
                        align: 'center'
                    },{
                        field: 'status',
                        title: 'Status',
                        sortable: true,
                        align: 'center',
                        formatter: displayMissionStatus
                    },{
                        field: 'title',
                        title: 'Title',
                        sortable: true,
                        align: 'center'
                    },{
                        field: 'country',
                        title: 'Country',
                        sortable: true,
                        align: 'center',
                        formatter: displayMissionCountry
                    },{
                        field: 'type',
                        title: 'Type',
                        sortable: true,
                        align: 'center'
                    },{
                        field: 'start',
                        title: 'Start',
                        sortable: true,
                        align: 'center'
                    },{
                        field: 'end',
                        title: 'End',
                        sortable: true,
                        align: 'center'
                    }
                ]
            ]
        })

        // Event to load the modal details
        $table.on('click-cell.bs.table', (field, value, row, $el) => {
            $.getJSON( 'mission/details/'+$el.idmission, (data) => {
                $('#detailsMissionModalLabel').text(data.title);
                let missionContent = '';

                // Missions infos
                missionContent += `
                    <div class="container-fluid">
                        <div class="row">
                            <label class="col-sm-2">Status</label>
                            <div class="col-sm-10">
                                ${displayMissionStatus(data.status)}
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2">Code</label>
                            <div class="col-sm-10">
                                ${data.code}
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2">Country</label>
                            <div class="col-sm-10">
                                ${displayMissionCountry(data.country)}
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2">Type</label>
                            <div class="col-sm-10">
                                ${data.type}
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2">Speciality</label>
                            <div class="col-sm-10">
                                ${data.speciality}
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2">Start</label>
                            <div class="col-sm-10">
                                ${data.start}
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-2">End</label>
                            <div class="col-sm-10">
                                ${data.end}
                            </div>
                        </div>
                    `;

                /*$.each( data, function( key, val ) {
                    items.push( "<li id='" + key + "'>" + val + "</li>" );
                });*/
                console.log(data);
                $('#detailsMissionModal .modal-body').html(missionContent);
                $('#detailsMissionModal').modal('toggle')
            });
        });
    }

    $(function() {
        initTable();
    })
</script>

{% endblock %}
